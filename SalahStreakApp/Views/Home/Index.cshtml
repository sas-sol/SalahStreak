@* @{
    ViewData["Title"] = "Dashboard";
    var models = new[] {
        "Participant", "AgeGroup", "BiometricLog", "AttendanceCalendar",
        "AttendanceScore", "Round", "Winner", "Reward"
    };
}

<div class="row">
    <div class="col-12">
        <h1 class="h2 mb-4 text-center">SalahStreak Admin Dashboard</h1>
    </div>
</div>

<div class="row g-4">
    @foreach (var aModel in models)
    {
        <div class="col-md-4 col-lg-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">@aModel</h5>
                    <a href="@Url.Action("Index", aModel)" class="btn btn-primary">View</a>
                </div>
            </div>
        </div>
    }
</div>
 *@

@{
    ViewData["Title"] = "Dashboard";
}
@section Styles {

}

@{
    var chartData = (IEnumerable<dynamic>)ViewData["ChartData"];

    var labels = chartData.Select(c => c.AgeGroup).ToList();
    var percentages = chartData.Select(c => c.Percentage).ToList();
    var colorPalette = new[]
        {
    "#fd7e14", // orange
    "#6f42c1", // purple
    "#28a745", // green
    "#007bff", // blue
    "#17a2b8", // teal
    "#e83e8c", // pink
    "#20c997", // cyan-green
    "#ffc107", // yellow
    "#6610f2", // indigo
    "#dc3545"  // red
};
    var colors = chartData.Select((c, i) => colorPalette[i % colorPalette.Length]).ToList();
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="~/style.css" />
<div>
    <link href="~/index.css" rel="stylesheet" />

    <div class="container my-4">
        <div class="row g-3 justify-content-start">

            <!-- Card 1 -->
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="stats-card">
                    <div class="stats-icon bg-success-subtle text-success">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stats-info">
                        <p class="stats-title">Total Users</p>
                        <h4 class="stats-value">@ViewData["ParticipantCount"]</h4>
                    </div>
                </div>
            </div>

            <!-- Card 2 -->
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="stats-card">
                    <div class="stats-icon bg-info-subtle text-info">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stats-info">
                        <p class="stats-title">Active Loops</p>
                        <h4 class="stats-value">@ViewData["RoundCount"]</h4>
                    </div>
                </div>
            </div>

            <!-- Card 3 -->
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="stats-card">
                    <div class="stats-icon bg-warning-subtle text-warning">
                        <i class="fas fa-medal"></i>
                    </div>
                    <div class="stats-info">
                        <p class="stats-title">Upcoming Winners</p>
                        <h4 class="stats-value">@ViewData["WinnerCount"]</h4>
                    </div>
                </div>
            </div>

            <!-- Card 4 -->
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="stats-card">
                    <div class="stats-icon bg-danger-subtle text-danger">
                        <i class="fas fa-gift"></i>
                    </div>
                    <div class="stats-info">
                        <p class="stats-title">Rewards Pending</p>
                        <h4 class="stats-value">@ViewData["RewardCount"]</h4>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <div class="container-fluid px-0 my-4">
        <div class="row g-4">

            <!-- Left: Top Performer -->
            <div class="col-12 col-lg-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                        <h6 class="card-title fw-bold" style="color:#1f2a38">
                            <i class="fas fa-star text-warning"></i> Top Performer of the Week
                        </h6>
                        <br />

                        @if (ViewData["Winners"] is IEnumerable<dynamic> topWinner && topWinner.Any())
                        {
                            var top = topWinner.First();

                            <div class="d-flex align-items-center my-3">
                                <img src="@top.Image" alt="Performer" class="rounded-circle me-3" width="60" height="60">
                                <div>
                                    <h6 class="mb-0 fw-bold">@top.User</h6>
                                    <small class="text-muted">@top.AgeGroup</small>
                                </div>
                            </div>

                            <!-- Progress Header -->
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">Progress</small>
                                <small class="fw-bold">@($"{top.Completion:F1}%")</small>
                            </div>

                            <!-- Progress Bar -->
                            <div class="progress mb-2" style="height: 8px; border-radius: 10px;">
                                <div class="progress-bar bg-info" role="progressbar"
                                     style="width:@($"{top.Completion:F1}%"); border-radius: 10px;">
                                </div>
                            </div>

                            <!-- Completion Text -->
                            <small class="text-warning">
                                <i class="fas fa-star"></i>  @($"{(top.Completion * 200 / 100):F0}/200 prayers completed")
                            </small>
                        }
                        else
                        {
                            <p class="text-muted">No top performer available</p>
                        }
                    </div>
                </div>
            </div>


            <!-- Right: Users About to Win -->
            <div class="col-12 col-lg-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="card-title">
                                <i class="fas fa-award"></i> Users About to Win
                            </h6>
                            <a href="#" class="text-decoration-none small fw-bold" style="color:#2db0c4">View All</a>
                        </div>

                        <div class="row g-3">
                            @foreach (var w in (IEnumerable<dynamic>)ViewData["Winners"])
                            {
                                <div class="col-12 col-sm-6 col-lg-4">
                                    <div class="user-card p-3 d-flex align-items-center shadow-sm rounded">
                                        <img src="@w.Image" class="rounded-circle me-3" alt="User" width="50" height="50">
                                        <div>
                                            <h6 class="mb-0">@w.User</h6>
                                            <small class="text-muted">@w.AgeGroup</small><br>
                                            <span class="text-warning fw-bold">@w.Completion</span>
                                        </div>
                                        <i class="fas fa-paper-plane ms-auto text-info"></i>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <div class="container-fluid px-0 my-4">
        <div class="row g-4 mx-0">

            <!-- Left Column -->
            <div class="col-lg-7 col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Top Performers</span>
                        <a href="#" class="small text-decoration-none" style="color:#2db0c4">View All</a>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-success">
                                <tr>
                                    <th>Rank</th>
                                    <th>User</th>
                                    <th>Age Group</th>
                                    <th>Completion %</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    var winners = (IEnumerable<dynamic>)ViewData["Winners"];
                                    foreach (var w in winners)
                                    {
                                        <tr>
                                            <td>
                                                @{
                                                    string bgColor = "white";
                                                    if (w.Rank == 1) bgColor = "#f7f4eb";
                                                    else if (w.Rank == 2) bgColor = "#f7f7f7";
                                                    else if (w.Rank == 3) bgColor = "#f2eae1";
                                                }
                                                <span style="
                                            display:inline-flex;
                                            align-items:center;
                                            justify-content:center;
                                            width:30px;
                                            height:30px;
                                            border-radius:50%;
                                            background-color:@bgColor;
                                            color:#242424;
                                            font-weight:bold;">
                                                    @w.Rank
                                                </span>
                                            </td>

                                            <td>
                                                <img src="@w.Image" class="rounded-circle me-2" width="30" height="30" alt="user" />
                                                @w.User
                                            </td>
                                            <td>@w.AgeGroup</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="progress w-100 me-2">
                                                        <div class="progress-bar" role="progressbar"
                                                             style="width: @w.Completion%;"
                                                             aria-valuenow="@w.Completion" aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                    <span>@w.Completion%</span>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="status-badge
                                        @(w.Status == "Active" ? "bg-success text-white" : "bg-secondary text-white")">
                                                    @w.Status
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-lg-5 col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> User Distribution
                    </div>
                    <div class="card-body text-center">
                        <canvas id="userChart" style="max-height: 200px;"></canvas>

                        <ul class="chart-legend mt-3 text-start">
                            @{
                                int idx = 0;
                                foreach (var item in chartData)
                                {
                                    <li class="legend-item">
                                        <span class="legend-box" style="background-color:@colorPalette[idx % colorPalette.Length];"></span>
                                        <span class="legend-label">@item.AgeGroup</span>
                                        <span class="legend-value">@Math.Round(item.Percentage, 2)%</span>
                                    </li>
                                    idx++;
                                }
                            }
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>

    @{
        var ageGroups = (IEnumerable<string>)ViewData["AgeGroups"];
        var users = (IEnumerable<dynamic>)ViewData["Users"];
    }

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" />

    <div class="container-fluid py-4">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">User Progress</h6>
                <div>
                    <button class="btn btn-sm btn-outline-secondary export-btn">Export Data</button>
                    <button class="btn btn-sm btn-outline-success">View All Users</button>
                </div>
            </div>
            <div class="card-body">

                <!-- Dynamic Tabs -->
                <ul class="nav nav-pills mb-3" id="filterTabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-group="all">All</button>
                    </li>
                    @foreach (var group in ageGroups)
                    {
                        <li class="nav-item">
                            <button class="nav-link" data-group="@group">@group</button>
                        </li>
                    }
                </ul>

                <!-- DataTable -->
                <div class="table-responsive">
                    <table id="userTable" class="table table-striped align-middle nowrap" style="width:100%">
                        <thead class="table-success">
                            <tr>
                                <th>Name</th>
                                <th>Age Group</th>
                                <th>Loop Dates</th>
                                <th>Prayers Completed</th>
                                <th>Completion %</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var u in users)
                            {
                                <tr data-group="@u.AgeGroup">
                                    <td>@u.Name</td>
                                    <td>@u.AgeGroup</td>
                                    <td>@u.LoopDates</td>
                                    <td>@u.PrayersCompleted</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress w-100 me-2">
                                                <div class="progress-bar bg-success"
                                                     role="progressbar"
                                                     style="width:@u.Completion%"
                                                     aria-valuenow="@u.Completion"
                                                     aria-valuemin="0" aria-valuemax="100">
                                                </div>
                                            </div>
                                            @($"{u.Completion:F1}%")
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">@u.Status</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
    @* <div class="container-fluid py-3"> *@
    @*     <div class="status-card d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center"> *@

    @*         <!-- Left Side: Text + Quote --> *@
    @*         <div class="mb-3 mb-md-0"> *@
    @*             <div class="status-text"><strong>Last updated:</strong> Today at 09:41 AM</div> *@
    @*             <div class="quote">"The reward of deeds depends upon the intentions." — Prophet Muhammad (PBUH)</div> *@
    @*         </div> *@

    @*         <!-- Right Side: Buttons --> *@
    @*         <div class="d-flex gap-2"> *@
    @*             <button class="btn btn-custom-outline"> *@
    @*                 🎁 Mark Rewards as Delivered *@
    @*             </button> *@
    @*             <button class="btn btn-custom"> *@
    @*                 💬 Send Broadcast Message *@
    @*             </button> *@
    @*         </div> *@
    @*     </div> *@
    @* </div> *@
    <br />
    <br />
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery (Required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <!-- Buttons extension -->
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script>
        $(document).ready(function () {
            var table = $('#userTable').DataTable({
                responsive: true,
                //dom: 'Bfrtip',   // Buttons show at top
            buttons: [
                {
                    extend: 'excelHtml5',
                    //text: 'Export to Excel',
                    className: 'btn btn-sm btn-outline-secondary',
                    title: 'UserProgress',
                    exportOptions: {
                        columns: ':visible' // all visible columns
                    }
                }
            ]
            });

                    // Move button to your custom button
        $(".export-btn").on("click", function () {
            table.button('.buttons-excel').trigger();
        });

            $('#filterTabs .nav-link').on('click', function () {
                $('#filterTabs .nav-link').removeClass('active');
                $(this).addClass('active');

                var group = $(this).data('group').trim();

                if (group === "all") {
                    table.column(1).search('').draw();
                } else {
                    // escape special regex chars like ( ) + ?
                    var escapedGroup = group.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    table.column(1).search('^' + escapedGroup + '$', true, false).draw();
                }
            });
        });
    </script>
    <script>
        const ctx = document.getElementById('userChart');

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(labels)),
                datasets: [{
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(percentages)),
                    backgroundColor: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(colors)),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    </script>
}
